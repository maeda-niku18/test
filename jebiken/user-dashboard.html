<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - ã‚¸ã‚§ãƒ“ã‚±ãƒ³</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        .nav-tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .nav-tab.active {
            background: white;
            border-bottom-color: #28a745;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .attendance-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .time-display {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }
        .status-display {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .status-working {
            background: #d4edda;
            color: #155724;
        }
        .status-break {
            background: #fff3cd;
            color: #856404;
        }
        .status-off {
            background: #f8d7da;
            color: #721c24;
        }
        .leave-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .leave-history {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .leave-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .leave-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard">
            <div class="dashboard-header">
                <h2>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                <div class="user-info">
                    <span id="userName"></span>
                    <button onclick="logout()" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('attendance')">å‹¤æ€ ç®¡ç†</button>
                <button class="nav-tab" onclick="showTab('leave-request')">æœ‰çµ¦ç”³è«‹</button>
                <button class="nav-tab" onclick="showTab('my-records')">è¨˜éŒ²ç¢ºèª</button>
            </div>

            <div id="attendance" class="tab-content active">
                <div class="attendance-section">
                    <div class="time-display" id="currentTime"></div>
                    <div class="status-display" id="statusDisplay">å‹¤å‹™å‰</div>
                    
                    <div class="attendance-buttons">
                        <button class="attendance-btn start-work" onclick="recordAttendance('start')" id="startBtn">ğŸ“ å‡ºå‹¤</button>
                        <button class="attendance-btn break-start" onclick="recordAttendance('breakStart')" id="breakStartBtn" disabled>â¸ï¸ ä¼‘æ†©é–‹å§‹</button>
                        <button class="attendance-btn break-end" onclick="recordAttendance('breakEnd')" id="breakEndBtn" disabled>â–¶ï¸ ä¼‘æ†©çµ‚äº†</button>
                        <button class="attendance-btn end-work" onclick="recordAttendance('end')" id="endBtn" disabled>ğŸ é€€å‹¤</button>
                    </div>
                    
                    <div id="attendanceStatus"></div>
                </div>

                <div id="todayAttendance">
                    <h3>æœ¬æ—¥ã®å‹¤æ€ è¨˜éŒ²</h3>
                    <div id="todayRecord"></div>
                </div>
            </div>

            <div id="leave-request" class="tab-content">
                <div class="leave-form">
                    <h3>æœ‰çµ¦ç”³è«‹</h3>
                    <form id="leaveRequestForm">
                        <div class="form-group">
                            <label for="leaveDate">å¸Œæœ›æ—¥</label>
                            <input type="date" id="leaveDate" required>
                        </div>
                        <div class="form-group">
                            <label for="leaveReason">ç†ç”±</label>
                            <textarea id="leaveReason" rows="3" placeholder="æœ‰çµ¦å–å¾—ã®ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required></textarea>
                        </div>
                        <button type="submit" class="admin-btn">ç”³è«‹æå‡º</button>
                    </form>
                </div>

                <div id="leaveHistory">
                    <h3>ç”³è«‹å±¥æ­´</h3>
                    <div id="leaveList" class="leave-history">
                        <!-- ç”³è«‹å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </div>

            <div id="my-records" class="tab-content">
                <h3>å‹¤æ€ è¨˜éŒ²</h3>
                <div style="margin-bottom: 20px;">
                    <label for="recordMonth">æœˆã‚’é¸æŠ:</label>
                    <input type="month" id="recordMonth" value="">
                    <button onclick="loadMonthlyRecords()" class="admin-btn">è¡¨ç¤º</button>
                </div>
                <div id="monthlyRecords">
                    <!-- æœˆåˆ¥è¨˜éŒ²ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { JebikenApp } from './firebase-app.js';

        class UserDashboard {
            constructor() {
                this.app = new JebikenApp();
                this.attendanceState = 'off'; // off, working, break
                this.init();
            }

            async init() {
                if (!this.app.requireAuth()) return;
                
                const user = this.app.getCurrentUser();
                document.getElementById('userName').textContent = `${user.name}`;
                
                // ç¾åœ¨ã®æœˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
                document.getElementById('recordMonth').value = new Date().toISOString().slice(0, 7);
                
                this.setupEventListeners();
                this.startClock();
                await this.loadLeaveHistory();
                await this.loadTodayAttendance();
            }

            setupEventListeners() {
                document.getElementById('leaveRequestForm').addEventListener('submit', (e) => this.handleLeaveRequest(e));
            }

            startClock() {
                const updateClock = () => {
                    const now = new Date();
                    document.getElementById('currentTime').textContent = now.toLocaleTimeString('ja-JP');
                };
                
                updateClock();
                setInterval(updateClock, 1000);
            }

            async recordAttendance(type) {
                try {
                    const now = new Date();
                    const today = now.toISOString().split('T')[0];
                    
                    // ä½ç½®æƒ…å ±å–å¾—ã‚’è©¦è¡Œ
                    const position = await this.getCurrentPosition();
                    
                    // Firestoreã«ä¿å­˜ï¼ˆå®Ÿè£…ã¯çœç•¥ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§ä»£ç”¨ï¼‰
                    let todayRecord = JSON.parse(localStorage.getItem(`attendance_${today}`) || '{}');
                    
                    switch(type) {
                        case 'start':
                            todayRecord.startTime = now.toISOString();
                            this.attendanceState = 'working';
                            this.updateButtons();
                            break;
                        case 'breakStart':
                            todayRecord.breakStartTime = now.toISOString();
                            this.attendanceState = 'break';
                            this.updateButtons();
                            break;
                        case 'breakEnd':
                            todayRecord.breakEndTime = now.toISOString();
                            this.attendanceState = 'working';
                            this.updateButtons();
                            break;
                        case 'end':
                            todayRecord.endTime = now.toISOString();
                            this.attendanceState = 'off';
                            this.updateButtons();
                            break;
                    }
                    
                    // ä½ç½®æƒ…å ±ã‚’è¨˜éŒ²ï¼ˆå–å¾—å¤±æ•—æ™‚ã¯nullã§ä¿å­˜ï¼‰
                    todayRecord.location = position;
                    localStorage.setItem(`attendance_${today}`, JSON.stringify(todayRecord));
                    
                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    let statusMessage = `${this.getAttendanceTypeText(type)}ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ`;
                    if (position.status === 'success') {
                        statusMessage += ` (ä½ç½®æƒ…å ±: ${position.lat.toFixed(4)}, ${position.lng.toFixed(4)})`;
                    } else {
                        statusMessage += ` (ä½ç½®æƒ…å ±: å–å¾—å¤±æ•— - ${position.message})`;
                    }
                    
                    this.showAttendanceStatus(statusMessage);
                    await this.loadTodayAttendance();
                    
                } catch (error) {
                    console.error('å‹¤æ€ è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', error);
                    this.showAttendanceStatus('è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }

            async getCurrentPosition() {
                return new Promise((resolve) => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                console.log('GPSå–å¾—æˆåŠŸ:', position.coords);
                                resolve({
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude,
                                    status: 'success',
                                    message: 'GPSä½ç½®æƒ…å ±å–å¾—æˆåŠŸ'
                                });
                            },
                            (error) => {
                                console.warn('GPSå–å¾—å¤±æ•—:', error);
                                let errorMessage = '';
                                switch(error.code) {
                                    case error.PERMISSION_DENIED:
                                        errorMessage = 'ä½ç½®æƒ…å ±ã®ä½¿ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ';
                                        break;
                                    case error.POSITION_UNAVAILABLE:
                                        errorMessage = 'ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“';
                                        break;
                                    case error.TIMEOUT:
                                        errorMessage = 'ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ';
                                        break;
                                    default:
                                        errorMessage = 'ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
                                        break;
                                }
                                resolve({ 
                                    lat: null, 
                                    lng: null, 
                                    status: 'failed',
                                    message: errorMessage
                                });
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 60000
                            }
                        );
                    } else {
                        resolve({ 
                            lat: null, 
                            lng: null, 
                            status: 'not_supported',
                            message: 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“'
                        });
                    }
                });
            }

            updateButtons() {
                const startBtn = document.getElementById('startBtn');
                const breakStartBtn = document.getElementById('breakStartBtn');
                const breakEndBtn = document.getElementById('breakEndBtn');
                const endBtn = document.getElementById('endBtn');
                const statusDisplay = document.getElementById('statusDisplay');

                // å…¨ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                [startBtn, breakStartBtn, breakEndBtn, endBtn].forEach(btn => {
                    btn.disabled = true;
                });

                // çŠ¶æ…‹ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                switch(this.attendanceState) {
                    case 'off':
                        startBtn.disabled = false;
                        statusDisplay.textContent = 'å‹¤å‹™å‰';
                        statusDisplay.className = 'status-display status-off';
                        break;
                    case 'working':
                        breakStartBtn.disabled = false;
                        endBtn.disabled = false;
                        statusDisplay.textContent = 'å‹¤å‹™ä¸­';
                        statusDisplay.className = 'status-display status-working';
                        break;
                    case 'break':
                        breakEndBtn.disabled = false;
                        statusDisplay.textContent = 'ä¼‘æ†©ä¸­';
                        statusDisplay.className = 'status-display status-break';
                        break;
                }
            }

            getAttendanceTypeText(type) {
                const typeMap = {
                    'start': 'å‡ºå‹¤',
                    'breakStart': 'ä¼‘æ†©é–‹å§‹',
                    'breakEnd': 'ä¼‘æ†©çµ‚äº†',
                    'end': 'é€€å‹¤'
                };
                return typeMap[type];
            }

            showAttendanceStatus(message) {
                const statusDiv = document.getElementById('attendanceStatus');
                statusDiv.innerHTML = `<p style="color: green; font-weight: bold;">${message}</p>`;
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
            }

            async loadTodayAttendance() {
                const today = new Date().toISOString().split('T')[0];
                const todayRecord = JSON.parse(localStorage.getItem(`attendance_${today}`) || '{}');
                const recordDiv = document.getElementById('todayRecord');

                if (Object.keys(todayRecord).length === 0) {
                    recordDiv.innerHTML = '<p>æœ¬æ—¥ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                let html = '<div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px;">';
                
                if (todayRecord.startTime) {
                    html += `<p><strong>å‡ºå‹¤:</strong> ${new Date(todayRecord.startTime).toLocaleTimeString('ja-JP')}</p>`;
                    this.attendanceState = 'working';
                }
                if (todayRecord.breakStartTime) {
                    html += `<p><strong>ä¼‘æ†©é–‹å§‹:</strong> ${new Date(todayRecord.breakStartTime).toLocaleTimeString('ja-JP')}</p>`;
                    this.attendanceState = 'break';
                }
                if (todayRecord.breakEndTime) {
                    html += `<p><strong>ä¼‘æ†©çµ‚äº†:</strong> ${new Date(todayRecord.breakEndTime).toLocaleTimeString('ja-JP')}</p>`;
                    this.attendanceState = 'working';
                }
                if (todayRecord.endTime) {
                    html += `<p><strong>é€€å‹¤:</strong> ${new Date(todayRecord.endTime).toLocaleTimeString('ja-JP')}</p>`;
                    this.attendanceState = 'off';
                }

                // ä½ç½®æƒ…å ±ã®è¡¨ç¤º
                if (todayRecord.location) {
                    if (todayRecord.location.status === 'success') {
                        html += `<p><strong>ğŸ“ ä½ç½®æƒ…å ±:</strong> ${todayRecord.location.lat.toFixed(4)}, ${todayRecord.location.lng.toFixed(4)}</p>`;
                    } else {
                        html += `<p><strong>âŒ ä½ç½®æƒ…å ±:</strong> å–å¾—å¤±æ•— (${todayRecord.location.message})</p>`;
                    }
                }

                html += '</div>';
                recordDiv.innerHTML = html;
                this.updateButtons();
            }

            async handleLeaveRequest(e) {
                e.preventDefault();
                
                const date = document.getElementById('leaveDate').value;
                const reason = document.getElementById('leaveReason').value;

                try {
                    await this.app.submitLeaveRequest(date, reason);
                    alert('æœ‰çµ¦ç”³è«‹ã‚’æå‡ºã—ã¾ã—ãŸ');
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                    document.getElementById('leaveRequestForm').reset();
                    
                    // ç”³è«‹å±¥æ­´ã‚’æ›´æ–°
                    await this.loadLeaveHistory();
                } catch (error) {
                    alert('ç”³è«‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            }

            async loadLeaveHistory() {
                try {
                    const user = this.app.getCurrentUser();
                    const requests = await this.app.getLeaveRequests(user.id);
                    const leaveList = document.getElementById('leaveList');

                    if (requests.length === 0) {
                        leaveList.innerHTML = '<p>ç”³è«‹å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                        return;
                    }

                    leaveList.innerHTML = requests.map(request => `
                        <div class="leave-item">
                            <h4>${request.date}</h4>
                            <p><strong>ç†ç”±:</strong> ${request.reason}</p>
                            <p><strong>ç”³è«‹æ—¥æ™‚:</strong> ${new Date(request.requestedAt).toLocaleString('ja-JP')}</p>
                            <p><strong>çŠ¶æ…‹:</strong> ${request.approved ? 'âœ… æ‰¿èªæ¸ˆã¿' : 'â³ æœªæ‰¿èª'}</p>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('ç”³è«‹å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
        }

        const dashboard = new UserDashboard();

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        window.showTab = function(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        };

        window.recordAttendance = function(type) {
            dashboard.recordAttendance(type);
        };

        window.logout = function() {
            dashboard.app.logout();
        };

        window.loadMonthlyRecords = function() {
            alert('æœˆåˆ¥è¨˜éŒ²æ©Ÿèƒ½ã¯ç°¡æ˜“ç‰ˆã®ãŸã‚çœç•¥ã•ã‚Œã¦ã„ã¾ã™');
        };
    </script>
</body>
</html>