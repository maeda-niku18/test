<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›³æ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - æ›¸ç±ç™»éŒ²</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
    <div class="sidebar">
        <h2>ğŸ“š å›³æ›¸ç®¡ç†</h2>
        <a href="home.html">ãƒ›ãƒ¼ãƒ </a>
        <a href="books.html">æ›¸ç±ç®¡ç†</a>
        <a href="users.html">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
        <a href="register.html">æ›¸ç±ç™»éŒ²</a>
        <a href="#" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </div>

    <div class="main-content">
        <h1>æ›¸ç±ç™»éŒ²</h1>
        
        <div class="card">
            <h2>ğŸ“± ã‚¹ãƒãƒ›ã§ISBNèª­ã¿å–ã‚Š</h2>
            <p>ä»¥ä¸‹ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§èª­ã¿å–ã£ã¦ã€æ›¸ç±ã®ISBNã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
            
            <div style="text-align: center; margin: 2rem 0;">
                <div id="qrcode" style="display: inline-block;"></div>
            </div>
            
            <div style="text-align: center; margin-top: 1rem;">
                <p style="font-size: 0.9rem; color: #666;">
                    QRã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ã€ä»¥ä¸‹ã®URLã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ï¼š<br>
                    <span id="scanner-url" style="font-family: monospace; background: #f0f0f0; padding: 0.2rem;"></span>
                </p>
            </div>
        </div>

        <div class="card">
            <h2>âœï¸ æ‰‹å‹•ç™»éŒ²</h2>
            <p>ISBNã‚³ãƒ¼ãƒ‰ã‚’ç›´æ¥å…¥åŠ›ã—ã¦æ›¸ç±ã‚’ç™»éŒ²ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
            
            <div class="form-group">
                <label for="manual-isbn">ISBNã‚³ãƒ¼ãƒ‰ (13æ¡)</label>
                <input type="text" id="manual-isbn" placeholder="9784000000000" maxlength="13">
            </div>
            
            <button class="btn" onclick="searchBookByISBN()">æ›¸ç±æƒ…å ±ã‚’æ¤œç´¢</button>
        </div>

        <!-- æ›¸ç±æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="book-info-area" style="display: none;" class="card">
            <h2>ğŸ“– æ›¸ç±æƒ…å ±</h2>
            <div id="book-info-content"></div>
            
            <div class="form-group" style="margin-top: 2rem;">
                <label for="manage-number">ç®¡ç†ç•ªå·</label>
                <input type="text" id="manage-number" placeholder="è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™">
            </div>
            
            <div class="form-group">
                <label for="location">é…ç½®å ´æ‰€ï¼ˆä»»æ„ï¼‰</label>
                <input type="text" id="location" placeholder="ä¾‹ï¼šçµµæœ¬ã‚³ãƒ¼ãƒŠãƒ¼ A-1">
            </div>
            
            <div class="form-group">
                <label for="remarks">å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
                <textarea id="remarks" rows="3" placeholder="æ›¸ç±ã«é–¢ã™ã‚‹å‚™è€ƒ"></textarea>
            </div>
            
            <button class="btn btn-primary" onclick="registerBook()">æ›¸ç±ã‚’ç™»éŒ²</button>
            <button class="btn" onclick="clearBookInfo()" style="margin-left: 1rem;">ã‚¯ãƒªã‚¢</button>
        </div>
    </div>

    <script>
        let currentBookData = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            generateQRCode();
        });

        function checkAuth() {
            const facilityId = sessionStorage.getItem('facilityId');
            if (!facilityId) {
                window.location.href = 'index.html';
                return;
            }
        }

        function generateQRCode() {
            const currentUrl = window.location.href;
            const scannerUrl = currentUrl.replace('register.html', 'scanner.html');
            
            document.getElementById('scanner-url').textContent = scannerUrl;
            
            QRCode.toCanvas(document.createElement('canvas'), scannerUrl, {
                width: 200,
                margin: 2,
            }, function (error, canvas) {
                if (error) {
                    console.error('QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                    return;
                }
                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = '';
                qrContainer.appendChild(canvas);
            });
        }

        async function searchBookByISBN() {
            const isbn = document.getElementById('manual-isbn').value.trim();
            if (!isbn) {
                alert('ISBNã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (isbn.length !== 13) {
                alert('13æ¡ã®ISBNã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                const bookInfo = await fetchBookFromGoogleAPI(isbn);
                displayBookInfo(bookInfo);
            } catch (error) {
                alert('æ›¸ç±æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function fetchBookFromGoogleAPI(isbn) {
            const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
            const data = await response.json();
            
            if (!data.items || data.items.length === 0) {
                throw new Error('æ›¸ç±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }

            const book = data.items[0];
            const volumeInfo = book.volumeInfo;
            
            return {
                code: isbn,
                name: volumeInfo.title || 'ä¸æ˜',
                description: volumeInfo.description || '',
                thumbnail_url: volumeInfo.imageLinks?.thumbnail || '',
                published_date: volumeInfo.publishedDate || '',
                manage_num: `${isbn}_001`
            };
        }

        function displayBookInfo(bookInfo) {
            currentBookData = bookInfo;
            
            const content = document.getElementById('book-info-content');
            content.innerHTML = `
                <div style="display: flex; gap: 2rem; margin-bottom: 1rem;">
                    ${bookInfo.thumbnail_url ? 
                        `<img src="${bookInfo.thumbnail_url}" alt="${bookInfo.name}" class="book-thumbnail-detail">` : 
                        '<div style="width: 150px; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 8px;">ç”»åƒãªã—</div>'
                    }
                    <div style="flex: 1;">
                        <h3>${bookInfo.name}</h3>
                        <p><strong>ISBN:</strong> ${bookInfo.code}</p>
                        <p><strong>å‡ºç‰ˆæ—¥:</strong> ${bookInfo.published_date || 'ä¸æ˜'}</p>
                        ${bookInfo.description ? `<p style="font-size: 0.9rem; color: #666;">${bookInfo.description.substring(0, 200)}...</p>` : ''}
                    </div>
                </div>
            `;
            
            document.getElementById('manage-number').value = bookInfo.manage_num;
            document.getElementById('book-info-area').style.display = 'block';
        }

        async function registerBook() {
            if (!currentBookData) {
                alert('æ›¸ç±æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const manageNum = document.getElementById('manage-number').value.trim();
            const location = document.getElementById('location').value.trim();
            const remarks = document.getElementById('remarks').value.trim();

            if (!manageNum) {
                alert('ç®¡ç†ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                const bookData = {
                    ...currentBookData,
                    manage_num: manageNum,
                    location: location,
                    remarks: remarks,
                    user_id: null,
                    created_at: new Date().toISOString()
                };

                // Firestore ã«ç™»éŒ²
                await registerToFirestore(bookData);
                
                alert('æ›¸ç±ãŒæ­£å¸¸ã«ç™»éŒ²ã•ã‚Œã¾ã—ãŸï¼');
                clearBookInfo();
                
            } catch (error) {
                alert('æ›¸ç±ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                console.error('Registration error:', error);
            }
        }

        async function registerToFirestore(bookData) {
            // Firebase SDK ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨åˆæœŸåŒ–
            const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
            const { getFirestore, collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

            const firebaseConfig = {
                apiKey: "AIzaSyBKhb3ctxhr-KT_4z32Iyfjo_tOc7LpImA",
                authDomain: "auth-test-ba58c.firebaseapp.com",
                projectId: "auth-test-ba58c",
                storageBucket: "auth-test-ba58c.firebasestorage.app",
                messagingSenderId: "856692946306",
                appId: "1:856692946306:web:d8cbddf97686f542bd0b9b"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            const docRef = await addDoc(collection(db, 'book'), bookData);
            console.log('Document written with ID: ', docRef.id);
        }

        function clearBookInfo() {
            currentBookData = null;
            document.getElementById('book-info-area').style.display = 'none';
            document.getElementById('manual-isbn').value = '';
            document.getElementById('manage-number').value = '';
            document.getElementById('location').value = '';
            document.getElementById('remarks').value = '';
        }

        function logout() {
            sessionStorage.removeItem('facilityId');
            window.location.href = 'index.html';
        }

        // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ ISBN ã‚’å—ã‘å–ã‚‹å‡¦ç†
        const urlParams = new URLSearchParams(window.location.search);
        const isbnFromUrl = urlParams.get('isbn');
        if (isbnFromUrl) {
            document.getElementById('manual-isbn').value = isbnFromUrl;
            searchBookByISBN();
        }
    </script>
</body>
</html>