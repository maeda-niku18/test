<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›³æ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="sidebar">
        <h2>ğŸ“š å›³æ›¸ç®¡ç†</h2>
        <a href="home.html">ãƒ›ãƒ¼ãƒ </a>
        <a href="books.html">æ›¸ç±ç®¡ç†</a>
        <a href="users.html">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
        <a href="#" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </div>

    <div class="main-content">
        <h1>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h1>
        
        <div class="card">
            <input type="text" id="search-input" class="search-box" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§æ¤œç´¢...">
            <div style="margin-top: 1rem;">
                <label>
                    <input type="radio" name="class-filter" value="all" checked> ã™ã¹ã¦
                </label>
                <label style="margin-left: 1rem;">
                    <input type="radio" name="class-filter" value="å¹´å°‘çµ„"> å¹´å°‘çµ„
                </label>
                <label style="margin-left: 1rem;">
                    <input type="radio" name="class-filter" value="å¹´ä¸­çµ„"> å¹´ä¸­çµ„
                </label>
                <label style="margin-left: 1rem;">
                    <input type="radio" name="class-filter" value="å¹´é•·çµ„"> å¹´é•·çµ„
                </label>
            </div>
            <div style="margin-top: 1rem;">
                <select id="sort-select">
                    <option value="name">åå‰é †</option>
                    <option value="class">ã‚¯ãƒ©ã‚¹é †</option>
                    <option value="created">ç™»éŒ²æ—¥é †</option>
                </select>
            </div>
        </div>

        <div id="users-container" class="user-list">
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBKhb3ctxhr-KT_4z32Iyfjo_tOc7LpImA",
            authDomain: "auth-test-ba58c.firebaseapp.com",
            projectId: "auth-test-ba58c",
            storageBucket: "auth-test-ba58c.firebasestorage.app",
            messagingSenderId: "856692946306",
            appId: "1:856692946306:web:d8cbddf97686f542bd0b9b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allUsers = [];
        let currentClassFilter = 'all';
        let currentSortOption = 'name';

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            setupEventListeners();
            loadUsers();
        });

        function checkAuth() {
            const facilityId = sessionStorage.getItem('facilityId');
            if (!facilityId) {
                window.location.href = '../index.html';
                return;
            }
        }

        function setupEventListeners() {
            const searchInput = document.getElementById('search-input');
            const classFilters = document.querySelectorAll('input[name="class-filter"]');
            const sortSelect = document.getElementById('sort-select');

            searchInput.addEventListener('input', filterAndSortUsers);
            
            classFilters.forEach(filter => {
                filter.addEventListener('change', (e) => {
                    currentClassFilter = e.target.value;
                    filterAndSortUsers();
                });
            });

            sortSelect.addEventListener('change', (e) => {
                currentSortOption = e.target.value;
                filterAndSortUsers();
            });
        }

        async function loadUsers() {
            try {
                const usersRef = collection(db, 'users');
                const querySnapshot = await getDocs(usersRef);
                
                allUsers = [];
                querySnapshot.forEach((doc) => {
                    allUsers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                filterAndSortUsers();
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                document.getElementById('users-container').innerHTML = 
                    '<div class="card"><p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p></div>';
            }
        }

        function filterAndSortUsers() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            let filteredUsers = allUsers.filter(user => {
                const matchesSearch = user.name.toLowerCase().includes(searchTerm);
                const matchesClass = currentClassFilter === 'all' || user.class === currentClassFilter;
                return matchesSearch && matchesClass;
            });

            // ã‚½ãƒ¼ãƒˆ
            filteredUsers.sort((a, b) => {
                switch (currentSortOption) {
                    case 'name':
                        return a.name.localeCompare(b.name, 'ja');
                    case 'class':
                        return a.class.localeCompare(b.class, 'ja');
                    case 'created':
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    default:
                        return 0;
                }
            });

            displayUsers(filteredUsers);
        }

        function displayUsers(users) {
            const container = document.getElementById('users-container');
            
            if (users.length === 0) {
                container.innerHTML = '<div class="card"><p>è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p></div>';
                return;
            }

            const usersHtml = users.map(user => `
                <div class="card user-card">
                    <div>
                        <div class="user-name">${user.name}</div>
                        <div class="user-class">${user.class}</div>
                        <div class="book-info">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—: ${getUserTypeText(user.userType)}</div>
                        <div class="book-info">ç™»éŒ²æ—¥: ${formatDate(user.createdAt)}</div>
                    </div>
                    <div>
                        <span class="status-label available">
                            ${getClassIcon(user.class)}
                        </span>
                    </div>
                </div>
            `).join('');

            container.innerHTML = usersHtml;
        }

        function getUserTypeText(userType) {
            switch (userType) {
                case 'child': return 'åœ’å…';
                case 'teacher': return 'å…ˆç”Ÿ';
                case 'staff': return 'ã‚¹ã‚¿ãƒƒãƒ•';
                default: return 'ä¸æ˜';
            }
        }

        function getClassIcon(className) {
            switch (className) {
                case 'å¹´å°‘çµ„': return 'ğŸŒ±';
                case 'å¹´ä¸­çµ„': return 'ğŸŒ¿';
                case 'å¹´é•·çµ„': return 'ğŸŒ³';
                default: return 'ğŸ‘¤';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'ä¸æ˜';
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP');
        }

        window.logout = function() {
            sessionStorage.removeItem('facilityId');
            window.location.href = '../index.html';
        }
    </script>
</body>
</html>